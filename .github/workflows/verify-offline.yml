name: Verify Offline Resilience

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  CARGO_TERM_COLOR: always

jobs:
  offline-check:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - uses: actions/checkout@v3

    - name: Install System Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libasound2-dev libdbus-1-dev pkg-config libsystemd-dev dbus python3-dbus alsa-utils

    - name: Install Rust
      uses: actions-rs/toolchain@v1
      with:
        profile: minimal
        toolchain: stable
        override: true

    - name: Build
      run: cargo build --release

    - name: Setup Dummy Config (Broken Network)
      run: |
        mkdir -p ~/.config/speechd-ng
        # Point Ollama to unreachable IP to simulate timeout/offline
        # Enable AI to force the code path to try connecting
        cat <<EOF > ~/.config/speechd-ng/Speech.toml
        ollama_url = "http://192.0.2.1:12345" 
        ollama_model = "void"
        enable_ai = true
        piper_model = "en_US-lessac-medium"
        tts_backend = "espeak" 
        EOF

    - name: Start Daemon (Background)
      run: |
        # Run dbus-run-session to create a session bus
        # We start the daemon in background
        # We need to export DBUS_SESSION_BUS_ADDRESS for the client
        echo "Starting Daemon..."
    
    - name: Run Resilience Test
      run: |
        # Wrap everything in dbus-run-session so we have a bus
        dbus-run-session -- bash -c '
          # 1. Start Daemon with output captured
          ./target/release/speechserverdaemon > daemon.log 2>&1 &
          DAEMON_PID=$!
          echo "Daemon started with PID: $DAEMON_PID"
          
          # 2. Wait for service to appear on bus (up to 30s)
          echo "Waiting for org.speech.Service to appear on bus..."
          for i in {1..30}; do
            if busctl status org.speech.Service >/dev/null 2>&1; then
               echo "Service is UP after $i seconds."
               break
            fi
            if ! kill -0 $DAEMON_PID 2>/dev/null; then
               echo "::error::Daemon died during startup!"
               cat daemon.log
               exit 1
            fi
            sleep 1
          done

          # 3. Run Benchmark/Check
          echo "Running Client Check..."
          python3 benchmarks/latency_test.py
          CLIENT_EXIT=$?

          if [ $CLIENT_EXIT -ne 0 ]; then
            echo "::error::Client test failed with exit code $CLIENT_EXIT"
            echo "--- Daemon Logs ---"
            cat daemon.log
            kill $DAEMON_PID
            exit 1
          fi

          # 4. Verify Daemon is still alive
          if ! kill -0 $DAEMON_PID; then
            echo "::error::Daemon crashed during execution"
            echo "--- Daemon Logs ---"
            cat daemon.log
            exit 1
          fi

          echo "Offline resilience verified."
          kill $DAEMON_PID
        '
